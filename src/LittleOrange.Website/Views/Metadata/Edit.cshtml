@using Coldew.Website;
@using Coldew.Api.UI;
@using Coldew.Website.Models;
@using Coldew.Api;
@{
    Layout = "~/Views/Metadata/Layout.cshtml";
    FormInfo formInfo = this.ViewBag.formInfo;
}

<script type="text/javascript" src='@this.Url.Content("~/js/coldewForm.js")'></script>
<h3>@this.ViewBag.Title</h3>
<form class="form-horizontal" id="editMetadataForm">
    <div id="coldewForm" ></div>
    <div class="form-group">
    <div class="controls">
        <button id="btnSave" type="submit" class="btn btn-primary" data-loading-text="保存中...">保存</button>
        <button id="btnCancel" type="button" class="btn btn-default" >取消</button>
    </div>
    </div>
</form>
<script language="javascript" type="text/javascript">
    var objectId = "@Request["objectId"]";
    var formModel = @this.Html.Raw(this.ViewBag.formModelJson);
    var metadataId = "@Request["metadataId"]";
    var returnUrl = "@this.Html.Raw(this.Url.Action("Index", new { objectId = Request["objectId"], viewId = Request["viewId"] }))";
    var metadataInfo = @this.Html.Raw(this.ViewBag.metadataInfoJson);

    $("#coldewForm").coldewForm({sections: formModel.sections});

$("#editMetadataForm").validate({
    sendForm : false,
    onBlur: true,
    onChange: true,
	eachValidField : function() {
		$(this).closest('.form-group').removeClass('error');
        $(this).next('.help-inline').hide();
	},
	eachInvalidField : function() {
		$(this).closest('.form-group').addClass('error');
        $(this).next('.help-inline').show();
	},
    valid: function(){
        var formValue = $("#editMetadataForm").getFormValue();
            
        $("#btnSave").button("loading");
        $.post("@this.Url.Action("EditPost")", {objectId: objectId, metadataId: metadataId, json: $.toJSON(formValue)}, function(data){
            $("#btnSave").button("reset");
            if(data.result == 0){
                location = returnUrl;
            }
            else{
                alert(data.message);
            }
        });
    }
})
.setFormValue(metadataInfo);

$("#btnCancel").click(function(){
    location = returnUrl;
});
</script>